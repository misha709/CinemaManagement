pipeline {
    agent any
    stages {
        stage('Build') {
            steps {
                sh 'dotnet restore'
                sh 'dotnet build --no-restore'
            }
        }

        stage('Test') {
            steps {
                sh 'dotnet test --no-build --no-restore --collect "XPlat Code Coverage"'
            }
            post {
                always {
                    recordCoverage(tools: [[parser: 'COBERTURA', pattern: '**/*.xml']], sourceDirectories: [[path: 'CinemaManagement.Tests/TestResults']])
                }
            }
        }

        stage('Publish') {
          steps {
            sh '''
              set -eux
        
              OUT_DIR="artifacts/dist"
              ARCHIVE="cm-${BUILD_NUMBER}.tar.gz"
        
              rm -rf artifacts
              mkdir -p "$OUT_DIR"
        
              dotnet publish ./CinemaManagement.Web/CinemaManagement.Web.csproj \
                -c Release \
                --no-restore \
                -o "$OUT_DIR"
        
              tar -czf "$ARCHIVE" -C artifacts dist
              ls -la "$ARCHIVE"
            '''
          }
          post {
            success {
              archiveArtifacts artifacts: '*.tar.gz', fingerprint: true
              script { notifyTelegram("‚úÖ SUCCESS", "Build succeeded") }
            
            }
            failure {
              script { notifyTelegram("‚ùå FAILED", "Build failed") }
            }
            aborted {
              script { notifyTelegram("‚ö™ ABORTED", "Build aborted") }
            }
            unstable {
              script { notifyTelegram("üü° UNSTABLE", "Build unstable") }
            }
          }
        }

    }    
}

def notifyTelegram(String status, String details) {
  withCredentials([
    string(credentialsId: 'tg-bot-token', variable: 'TG_TOKEN'),
    string(credentialsId: 'tg-chat-ids', variable: 'TG_CHAT_IDS')
  ]) {
    sh """
      set +x

      TEXT="${status}%0AJob: ${env.JOB_NAME}%0ABuild: #${env.BUILD_NUMBER}%0A${details}%0AURL: ${env.BUILD_URL}"

      IFS=',' read -ra CHATS <<< "${TG_CHAT_IDS}"

      for CHAT_ID in "\${CHATS[@]}"; do
        curl -sS -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \\
          -d "chat_id=\${CHAT_ID}" \\
          --data-urlencode "text=\${TEXT}"
      done
    """
  }
}
